<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <script src="/socket.io/socket.io.js"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

  <%- include("./partials/header") %>

  <div class="flex-1 max-w-3xl mx-auto w-full flex flex-col bg-white shadow-lg">

    <div class="flex items-center gap-3 px-4 py-3 border-b bg-gray-50">
      <img
        src="<%= receiver.profilepic %>"
        class="w-10 h-10 rounded-full object-cover"
        alt="profile"
      />
      <div>
        <h2 class="font-semibold text-gray-800">
          <%= receiver.username %>
        </h2>
        <p class="text-xs text-gray-400">Private chat</p>
      </div>
    </div>

    <div
      id="chatBox"
      class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-100"
    >
      <% messages.forEach(m => { %>
        <div
          class="flex <%= m.sender.equals(loggedInUserId) ? 'justify-end' : 'justify-start' %>"
        >
          <div
            class="max-w-[75%] px-4 py-2 rounded-2xl text-sm
            <%= m.sender.equals(loggedInUserId)
              ? 'bg-indigo-500 text-white rounded-br-none'
              : 'bg-white text-gray-800 rounded-bl-none shadow' %>"
          >
            <p><%= m.text %></p>
            <span class="block text-[10px] mt-1 text-right opacity-70">
              <%= new Date(m.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
            </span>
          </div>
        </div>
      <% }) %>
    </div>

    <form
      id="chatForm"
      class="flex items-center gap-2 p-3 border-t bg-white"
    >
      <input
        id="msgInput"
        type="text"
        placeholder="Type a message..."
        class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-400"
        autocomplete="off"
      />
      <button
        type="submit"
        class="bg-indigo-500 hover:bg-indigo-600 text-white px-5 py-2 rounded-full transition"
      >
        Send
      </button>
    </form>

  </div>

<script>
  const socket = io();

  const receiverId = "<%= receiver._id %>";
  const loggedInUserId = "<%= loggedInUserId %>";

  const chatBox = document.getElementById("chatBox");
  const msgInput = document.getElementById("msgInput");
  const chatForm = document.getElementById("chatForm");

  socket.emit("joinRoom", { receiverId });

  chatBox.scrollTop = chatBox.scrollHeight;

  chatForm.addEventListener("submit", e => {
    e.preventDefault();

    const text = msgInput.value.trim();
    if (!text) return;

    socket.emit("sendMessage", { receiverId, text });
    msgInput.value = "";
  });

  socket.on("newMessage", msg => {
    const isMine = msg.senderId === loggedInUserId;

    const wrapper = document.createElement("div");
    wrapper.className = `flex ${isMine ? "justify-end" : "justify-start"}`;

    wrapper.innerHTML = `
      <div class="max-w-[75%] px-4 py-2 rounded-2xl text-sm
        ${isMine
          ? "bg-indigo-500 text-white rounded-br-none"
          : "bg-white text-gray-800 rounded-bl-none shadow"}">
        <p>${msg.text}</p>
        <span class="block text-[10px] mt-1 text-right opacity-70">
          ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </span>
      </div>
    `;

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>

</body>
</html>
